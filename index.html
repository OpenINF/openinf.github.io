<!--
  * @file The development server page
  * @author The OpenINF Authors & Friends
  * @license MIT OR Apache-2.0 OR BlueOak-1.0.0
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta
      name="viewport"
      content="width=device-width,minimum-scale=1,initial-scale=1">
    <link type="image/svg+xml" rel="icon" href="logo.svg">
    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.iu.edu/style.css?family=BentonSans:regular,bold|BentonSansCond:regular,bold|GeorgiaPro:regular|BentonSansLight:regular">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background-color: #0f1113;
        overflow: hidden;
      }
      main {
        width: 100vw;
        height: 100vh;
        position: relative;
        text-align: center;
        padding-bottom: 48px;
      }
      header {
        background-color: #0077ee;
        height: 48px;
        width: 100vw;
        display: block;
      }
      header #branding {
        font-size: 18px;
        font-family: BentonSansCondRegular, Arial, serif;
        text-decoration: none;
        font-weight: 600;
        line-height: 48px;
        color: #0f1113;
      }
      header ul {
        margin: 0;
        padding: 0;
        float: right;
      }
      header li {
        color: #d7dde3;
        float: left;
        height: 48px;
        font-size: 14px;
        float: left;
        list-style-type: none;
        margin: 0;
        padding: 0 6px;
        line-height: 48px;
        font-family: BentonSansRegular, Arial, serif;
      }
      header li a {
        text-decoration: none;
        color: inherit;
      }
      header li a:hover {
        text-decoration: underline;
      }
      header svg {
        height: 36px;
        width: 36px;
        float: left;
        display: block;
        opacity: 0.88;
        margin: 6px;
      }
      #console {
        width: 100vw;
        height: 100%;
        overflow: scroll;
        overflow-x: scroll;
        position: relative;
      }
      #console #icon {
        height: 33%;
        position: absolute;
        top: 50%;
        transform: translateX(-50%) translateY(-50%);
        z-index: 1;
      }
      #console #stream {
        color: #d7dde3;
        font-family: monospace;
        text-align: left;
        position: absolute;
        z-index: 2;
        padding: 1rem;
      }
    </style>
    <link rel="canonical" href="/examples/">
    <title>INF Dev Server</title>
  </head>
  <body>
    <header>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="#FFF" stroke="#0F1113" stroke-width="10"/>
        <path d="m 56.54917,20.000001 c -3.873051,0 -7.484223,2.989324 -7.484223,6.982354 0,3.99301 3.611172,7.07745 7.484223,7.002452 a 7.2598423,7.2736721 0 0 0 7.484458,-6.982292 c 0,-3.964906 -3.611214,-7.002514 -7.484458,-7.002514 z m -6.362374,20.330167 c -4.584181,0 -10.486469,0.712481 -13.9199,4.058703 -6.183973,5.998842 3.095685,12.409887 7.913779,15.090684 -2.076836,7.498563 -6.137005,19.684367 5.837941,20.443564 v 0.066 c 4.481308,0.112137 10.553962,-0.600194 13.762882,-4.124637 5.781575,-6.411234 -2.245131,-12.344477 -7.418663,-15.156491 2.161176,-7.620413 6.070223,-20.087145 -6.176039,-20.377731 z m -8.465622,5.140595 c 1.445419,-0.0925 3.034993,0.338076 3.85363,1.027122 l 0.0095,0.02368 c 2.067563,1.715303 0.430568,6.477675 -0.08415,8.483547 -1.758818,-1.077926 -7.239723,-4.602475 -6.762609,-7.41439 0.238451,-1.406046 1.538482,-2.021942 2.983909,-2.114492 z m 13.38819,19.671052 c 2.806641,1.612209 4.958414,3.365377 5.613251,5.380624 l -0.01389,-0.0085 c 0.935621,2.999478 -3.067608,5.136591 -5.341015,3.515018 -2.488443,-1.874495 -0.934749,-6.561579 -0.260842,-8.886156 z" />
      </svg>
      <a id="branding">OpenINF</a>
      <ul>
        <li><a href="">Users</a></li>
        <li><a href="">Developers</a></li>
        <li><a href="">GitHub</a></li>
        <li><a href="">Find File</a></li>
        <li><a href="docs/glossary.md">Glossary</a></li>
      </ul>
    </header>
    <main>
      <div id="console">
        <svg id="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#0b0c0d" stroke-width="10"/>
          <path fill="#0b0c0d" d="m 56.54917,20.000001 c -3.873051,0 -7.484223,2.989324 -7.484223,6.982354 0,3.99301 3.611172,7.07745 7.484223,7.002452 a 7.2598423,7.2736721 0 0 0 7.484458,-6.982292 c 0,-3.964906 -3.611214,-7.002514 -7.484458,-7.002514 z m -6.362374,20.330167 c -4.584181,0 -10.486469,0.712481 -13.9199,4.058703 -6.183973,5.998842 3.095685,12.409887 7.913779,15.090684 -2.076836,7.498563 -6.137005,19.684367 5.837941,20.443564 v 0.066 c 4.481308,0.112137 10.553962,-0.600194 13.762882,-4.124637 5.781575,-6.411234 -2.245131,-12.344477 -7.418663,-15.156491 2.161176,-7.620413 6.070223,-20.087145 -6.176039,-20.377731 z m -8.465622,5.140595 c 1.445419,-0.0925 3.034993,0.338076 3.85363,1.027122 l 0.0095,0.02368 c 2.067563,1.715303 0.430568,6.477675 -0.08415,8.483547 -1.758818,-1.077926 -7.239723,-4.602475 -6.762609,-7.41439 0.238451,-1.406046 1.538482,-2.021942 2.983909,-2.114492 z m 13.38819,19.671052 c 2.806641,1.612209 4.958414,3.365377 5.613251,5.380624 l -0.01389,-0.0085 c 0.935621,2.999478 -3.067608,5.136591 -5.341015,3.515018 -2.488443,-1.874495 -0.934749,-6.561579 -0.260842,-8.886156 z" />
        </svg>
        <!-- Stdout/err output here. -->
        <div id="stream"></div>
      </div>
    </main>
    <script>
      window.addEventListener('DOMContentLoaded', (event) => {
        'use strict';

        // ---------------------------------------------------------------------------
        // Requirements
        // ---------------------------------------------------------------------------

        let messageNumber = 0;

        // ---------------------------------------------------------------------------
        // Helpers
        // ---------------------------------------------------------------------------

        function getElement(id) {
          return document.getElementById(id);
        }

        // Messages come in pairs. Each pair should replace the previous pair.
        // TODO: Find a better way to determine pairs (use an array).
        function maybeClearConsole() {
          if (messageNumber % 2 === 0) {
            // EVEN
            getElement('stream').innerHTML = ''; // CLEAR
          }
        }

        function addMessage(message) {
          maybeClearConsole();
          const preTag = document.createElement('pre');
          preTag.appendChild(document.createTextNode(message));
          getElement('stream').appendChild(preTag);
          messageNumber++;
        }

        // ---------------------------------------------------------------------------
        // Main
        // ---------------------------------------------------------------------------
        // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
        // https://stackoverflow.com/questions/3780511/reconnection-of-client-when-server-reboots-in-websocket
        // Reconnection of Client when server reboots in WebSocket.
        let webSocket = null;

        // (Re)connecting WebSocket.
        function connect() {
          // Create WebSocket connection.
          webSocket = new WebSocket(`ws://${location.host}`);

          // Connection opened.
          webSocket.onopen = () => {
            // Fired once connection successfully opens.
            console.log('Now connected to server.');
            webSocket.send('Hello, Server!');
            keepAlive();
          };

          // Message received from server socket.
          webSocket.onmessage = (event) => {
            console.log('New message from backend WebSocket!');
            addMessage(event.data);
          };

          // Connection closed.
          webSocket.onclose = (event) => {
            console.log('Frontend WebSocket connection closed!');
            cancelKeepAlive();
            check();
          };
        }

        // Check if the WebSocket is disconnected. If so, make reconnection.
        function check() {
          if (!webSocket || webSocket.readyState === WebSocket.CLOSED)
            connect();
        }

        connect();
        setInterval(check, 5000);

        /**
         * Working with WebSocket Timeout
         *
         * Some servers and firewalls timeout and terminate (disconnect) established
         * WebSocket connections after an "idle period" of inactivity (no messages
         * being sent from the client). To deal w/ this situation, we must send a
         * periodic message (ping) to the server.
         *
         * To control the timeout, we will add two functions in our code: one to
         * ensure connection keep alive and another to cancel the keep alive.
         *
         * Also, we need a common timerID variable.
         *
         * @see https://www.jstips.co/en/javascript/working-with-websocket-timeout/
         */
        let timerId = 0;

        function keepAlive() {
          const timeout = 20000;
          if (webSocket.readyState === webSocket.OPEN) {
            webSocket.send('');
          }
          timerId = setTimeout(keepAlive, timeout);
        }

        function cancelKeepAlive() {
          if (timerId) {
            clearTimeout(timerId);
          }
        }
      });
    </script>
  </body>
</html>
